<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="/style.css"/>
    <link rel="stylesheet" href="fonts.css"/>
    <title>Create Map Sample | Longdo Map</title>
    <style type="text/css">
        html {
            height: 100%;
        }

        body {
            margin: 0px;
            height: 100%;
        }

        #map {
            height: 50%;
        }

        #result {
            height: 50%;
        }
    </style>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzVcNcsc6AaJzd6CGWQ14UXVu_cK6wZg8&libraries=places&callback=initMap"></script>
    <script type="text/javascript">
        let map, startMarker, endMarker, directionsService, directionsRenderer, polyline;

        function initMap() {
            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                center: {lat: 13.764953, lng: 100.538316},
                zoom: 8,
            });

            // Set up directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Initialize autocomplete for location inputs
            const startInput = document.getElementById("start-location");
            const endInput = document.getElementById("end-location");
            const startAutocomplete = new google.maps.places.Autocomplete(startInput);
            const endAutocomplete = new google.maps.places.Autocomplete(endInput);

            // Set up markers and update locations when user selects a place
            startAutocomplete.addListener("place_changed", () => {
                const place = startAutocomplete.getPlace();
                if (!place.geometry) return;
                setMarker(place.geometry.location, "start");
                calculateRoute(); // Calculate route when start location is selected
            });

            endAutocomplete.addListener("place_changed", () => {
                const place = endAutocomplete.getPlace();
                if (!place.geometry) return;
                setMarker(place.geometry.location, "end");
                calculateRoute(); // Calculate route when end location is selected
            });
        }

        function setMarker(location, type) {
            // Set or update start and end markers
            if (type === "start") {
                if (startMarker) startMarker.setMap(null);
                startMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "Start Location",
                    draggable: true,
                });
                document.getElementById("marker1_lat").value = location.lat();
                document.getElementById("marker1_lon").value = location.lng();
                startMarker.addListener("dragend", updateMarkerPosition);
            } else if (type === "end") {
                if (endMarker) endMarker.setMap(null);
                endMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "End Location",
                    draggable: true,
                });
                document.getElementById("marker2_lat").value = location.lat();
                document.getElementById("marker2_lon").value = location.lng();
                endMarker.addListener("dragend", updateMarkerPosition);
            }
            map.panTo(location);
        }

        function updateMarkerPosition() {
            // Update location inputs based on marker position
            document.getElementById("marker1_lat").value = startMarker.getPosition().lat();
            document.getElementById("marker1_lon").value = startMarker.getPosition().lng();
            document.getElementById("marker2_lat").value = endMarker.getPosition().lat();
            document.getElementById("marker2_lon").value = endMarker.getPosition().lng();
            calculateRoute(); // Recalculate route when markers are dragged
        }

        function calculateRoute() {
            if (startMarker && endMarker) {
                const start = startMarker.getPosition();
                const end = endMarker.getPosition();

                directionsService.route({
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.DRIVING,
                }, (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);

                        // Draw the polyline on the map
                        if (polyline) polyline.setMap(null); // Remove existing polyline
                        const route = response.routes[0].legs[0];
                        polyline = new google.maps.Polyline({
                            path: route.steps.map(step => step.start_location),
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                        });
                        polyline.setMap(map);

                        const distance = route.distance.value / 1000; // in kilometers
                        const roundedDistance = Math.ceil(distance);
                        const totalPrice = calculatePrice(roundedDistance);
                        document.getElementById("distance").value = distance;
                        document.getElementById("total-price").innerHTML = totalPrice;
                        document.getElementById("totalPriceInput").value = totalPrice;
                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                });
            }
        }

        function calculatePrice(distanceValue) {
            const initial_price = 100; // Base price in Baht
            const initial_distance = 5; // Initial distance in km included in base price
            const additional_price_per_km = 6; // Additional price per km after initial distance
            let basePrice;

            if (distanceValue <= initial_distance) {
                basePrice = initial_price;
            } else {
                const extra_distance = distanceValue - initial_distance;
                const extra_cost = extra_distance * additional_price_per_km;
                basePrice = initial_price + extra_cost;
            }

            return parseFloat(basePrice.toFixed(2)); // Return total price rounded to two decimal places
        }

        function submitForm(event) {
            event.preventDefault(); // Prevent default form submission
            const formData = new FormData(document.getElementById("reservationForm"));
        }

        let totalPrice = 0;

        // Function to update total price based on selected options
        function updateTotalPrice() {
          const checkboxes = document.querySelectorAll(".option-checkbox");
          totalPrice = 0; // Reset total price

          checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
              totalPrice += parseFloat(checkbox.value); // Add checked option price
            }
          });

          // Update the displayed total price
          document.getElementById("total-price").innerHTML = totalPrice.toFixed(2);
          document.getElementById("totalPriceInput").value = totalPrice.toFixed(2); // Update hidden input
        }

        // Attach change event listeners to checkboxes
        document.addEventListener('DOMContentLoaded', () => {
          const checkboxes = document.querySelectorAll(".option-checkbox");
          checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", updateTotalPrice);
          });
        });
    </script>
</head>

<body class="bg-gradient-to-b from-white via-cyan-50 to-white h-screen">
<input id="myButton" type="hidden" value="100">

<script type="module">
    // Wait for the DOM to fully load before selecting elements
    document.addEventListener('DOMContentLoaded', () => {
        const button = document.getElementById('myButton');
        button.addEventListener('change', () => {
            alert('Button was clicked!');
        });
        document.getElementById('myButton').value = "200";
    });
</script>

<nav class="bg-white drop-shadow-md">
    <div class="mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex h-16 items-center justify-between">
          <div
            class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-start"
          >
            <!-- logo -->
            <div class="flex flex-shrink-0 items-center">
              <img src="/img.png" alt="" class="size-14 mr-3" />
              <a href="/" class="text-3xl font-bold">CaliCloud</a>
            </div>
            <div class="hidden sm:ml-6 sm:block">
              <div class="flex space-x-4">
                <a href="" class="rounded-md px-3 py-4 text-xl text-gray-400"
                  >Home</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <h1 class="mt-5 mb-5 flex justify-center text-4xl font-semibold">
      Reservation Service
    </h1>
    <div class="m-5 mt-1 border-2 border-black" id="map"></div>
    <div class="hidden" id="result"></div>

    <div class="flex">
      <!--Vehicle Image-->
      <div class="basis-2/5 ml-5 w-full flex justify-center text-center">
        <div class="w-fit">
          <h1 class="mb-2 text-xl font-medium">(Vehicle Selected)</h1>
          <img id="vehicle_image" class="w-auto h-auto" src="/img.png" />
          <p class="mt-3 text-xl font-medium" id="vehicle_name"></p>
        </div>
      </div>

      <div
        class="m-5 mt-0 w-full bg-white border-2 border-black p-6 rounded-xl"
      >
        <form id="reservationForm" method="POST" onsubmit="submitForm(event)">
          <!--Input Date time-->
          <h1 class="mb-3 text-xl font-medium">
            1. Select your pick-up and drop-off location from the map above.
          </h1>
          <hr />
          <h1 class="mt-5 mb-2 text-xl font-medium">
            2. Select Date-Time Pick-Up
          </h1>
          <div class="flex gap-4">
            <input
              id="date"
              class="border border-slate-300 h-12 w-full px-2 mb-5"
              type="date"
              name="pickup_date"
              placeholder="Select Pick-Up Date"
              required
            />
            <input
              id="time"
              class="border border-slate-300 h-12 w-full px-2 mb-5"
              type="time"
              name="pickup_time"
              placeholder="Select Pick-Up Time"
              required
            />
          </div>

          <hr />
          <!--Service Option-->
          <h1 class="mt-5 mb-2 text-xl font-medium">3. Select Option(s)</h1>
          <ul id="option_show">
            <li>
              <input
                class="mr-2 option-checkbox"
                type="checkbox"
                id="option1"
                name="option1"
                value="100"
              />Packing Service +100
            </li>
            <li>
              <input
                class="mr-2 option-checkbox"
                type="checkbox"
                id="option1"
                name="option1"
                value="100"
              />Packing Service +100
            </li>
          </ul>

          <!-- Hidden fields for marker1 -->
          <input type="hidden" id="marker1_lat" name="marker1_lat" />
          <input type="hidden" id="marker1_lon" name="marker1_lon" />

          <!-- Hidden fields for marker2 -->
          <input type="hidden" id="marker2_lat" name="marker2_lat" />
          <input type="hidden" id="marker2_lon" name="marker2_lon" />

          <input type="hidden" name="distance" id="distance" />
          <input type="hidden" id="totalPriceInput" name="total_price" />

          <hr class="mt-5" />
          <div class="mt-5">
            <h1 class="mb-2 text-xl font-medium">
              4. Select Method for Payment
            </h1>
            <div class="">
              <ul>
                <li>
                  <input
                    onclick="show_payment('card', 'qr')"
                    class="mr-2 option-checkbox"
                    type="radio"
                    id="card"
                    name="pay"
                    value="0"
                  />Credit/Debit Card
                </li>
                <div id="card-pay" class="hidden flex gap-2">
                  <input
                    id=""
                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                    type="text"
                    name="card_number"
                    placeholder="Card Number"
                  />
                  <input
                    id=""
                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                    type="text"
                    name="expire_date"
                    placeholder="Expiration Date (mm/yy)"
                  />
                  <input
                    id=""
                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                    type="text"
                    name="secure_code"
                    placeholder="Security Code"
                  />
                </div>
                <li>
                  <input
                    onclick="show_payment('qr', 'card')"
                    class="mr-2 option-checkbox"
                    type="radio"
                    id="qr"
                    name="pay"
                    value="0"
                  />QR Code
                </li>
                <div id="qr-pay" class="hidden">
                  <img class="" src="/qr.png" />
                </div>
              </ul>
            </div>
          </div>

          <hr class="mt-5" />

          <div class="flex mt-5">
            <p class="flex-1 text-2xl font-medium">
              Total Price: <span id="total-price">0</span> Baht
            </p>
            <button
              class="bg-blue-700 hover:bg-gray-400 text-white font-bold py-3 px-4 rounded inline-flex items-center"
              type="submit"
            >
                <!-- logo -->
                <div class="flex flex-shrink-0 items-center">
                    <img src="/img.png" alt="" class="size-14 mr-3"/>
                    <a href="/" class="text-3xl font-bold">CaliCloud</a>
                </div>
                <div class="hidden sm:ml-6 sm:block">
                    <div class="flex space-x-4">
                        <a href="" class="rounded-md px-3 py-4 text-xl text-gray-400"
                        >Home</a
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<h1 class="mt-5 mb-5 flex justify-center text-4xl font-semibold">
    Reservation Service
</h1>
<div class="flex justify-center mb-3">
    <input id="start-location" type="text" placeholder="Start Location" style="width: 300px; margin-right: 10px;"/>
    <input id="end-location" type="text" placeholder="End Location" style="width: 300px;"/>
</div>
<div class="m-5 mt-1 border-2 border-black" id="map"></div>
<div class="hidden" id="result"></div>

<div class="flex">
    <!--Vehicle Image-->
    <div class="basis-2/5 ml-5 w-full flex justify-center text-center">
        <div class="w-fit">
            <h1 class="mb-2 text-xl font-medium">(Vehicle Selected)</h1>
            <img id="vehicle_image" class="w-auto h-auto" src="/img.png"/>
            <p class="mt-3 text-xl font-medium" id="vehicle_name"></p>
        </div>
    </div>

    <div
            class="m-5 mt-0 w-full bg-white border-2 border-black p-6 rounded-xl"
    >
        <form id="reservationForm" method="POST" onsubmit="submitForm(event)">
            <!--Input Date time-->
            <h1 class="mb-3 text-xl font-medium">
                1. Select your pick-up and drop-off location from the map above.
            </h1>
            <hr/>
            <h1 class="mt-5 mb-2 text-xl font-medium">
                2. Select Date-Time Pick-Up
            </h1>
            <div class="flex gap-4">
                <input
                        id="date"
                        class="border border-slate-300 h-12 w-full px-2 mb-5"
                        type="date"
                        name="pickup_date"
                        placeholder="Select Pick-Up Date"
                        required
                />
                <input
                        id="time"
                        class="border border-slate-300 h-12 w-full px-2 mb-5"
                        type="time"
                        name="pickup_time"
                        placeholder="Select Pick-Up Time"
                        required
                />
            </div>

            <hr/>
            <!--Service Option-->
            <h1 class="mt-5 mb-2 text-xl font-medium">3. Select Option(s)</h1>
            <ul>
                <li>
                    <input
                            class="mr-2 option-checkbox"
                            type="checkbox"
                            id="option1"
                            name="option1"
                            value="100"
                    />Packing Service +100
                </li>
                <li>
                    <input
                            class="mr-2 option-checkbox"
                            type="checkbox"
                            id="option2"
                            name="option2"
                            value="200"
                    />Packing Service +200
                </li>
                <li>
                    <input
                            class="mr-2 option-checkbox"
                            type="checkbox"
                            id="option3"
                            name="option3"
                            value="300"
                    />Packing Service +300
                </li>
            </ul>

            <!-- Hidden fields for marker1 -->
            <input type="hidden" id="marker1_lat" name="marker1_lat"/>
            <input type="hidden" id="marker1_lon" name="marker1_lon"/>

            <!-- Hidden fields for marker2 -->
            <input type="hidden" id="marker2_lat" name="marker2_lat"/>
            <input type="hidden" id="marker2_lon" name="marker2_lon"/>

            <input type="hidden" name="distance" id="distance"/>
            <input type="hidden" id="totalPriceInput" name="total_price"/>

            <hr class="mt-5"/>
            <div class="mt-5">
                <h1 class="mb-2 text-xl font-medium">
                    4. Select Method for Payment
                </h1>
                <div class="">
                    <ul>
                        <li>
                            <input
                                    onclick="show_payment('card', 'qr')"
                                    class="mr-2 option-checkbox"
                                    type="radio"
                                    id="card"
                                    name="pay"
                                    value="0"
                            />Credit/Debit Card
                        </li>
                        <div id="card-pay" class="hidden flex gap-2">
                            <input
                                    id=""
                                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                                    type="text"
                                    name="card_number"
                                    placeholder="Card Number"
                                    required
                            />
                            <input
                                    id=""
                                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                                    type="text"
                                    name="expire_date"
                                    placeholder="Expiration Date (mm/yy)"
                                    required
                            />
                            <input
                                    id=""
                                    class="border border-slate-300 h-12 w-full px-2 mb-5"
                                    type="text"
                                    name="secure_code"
                                    placeholder="Security Code"
                                    required
                            />
                        </div>
                        <li>
                            <input
                                    onclick="show_payment('qr', 'card')"
                                    class="mr-2 option-checkbox"
                                    type="radio"
                                    id="qr"
                                    name="pay"
                                    value="0"
                            />QR Code
                        </li>
                        <div id="qr-pay" class="hidden">
                            <img class="" src="/qr.png"/>
                        </div>
                    </ul>
                </div>
            </div>

            <hr class="mt-5"/>

            <div class="flex mt-5">
                <p class="flex-1 text-2xl font-medium">
                    Total Price: <span id="total-price">0</span> Baht
                </p>
                <button
                        class="bg-blue-700 hover:bg-gray-400 text-white font-bold py-3 px-4 rounded inline-flex items-center"
                        type="submit"
                >
                    Submit
                </button>
            </div>
        </form>
    </div>
</div>

<footer class="bg-[#3d4854] text-white">
    <div
            class="container mx-auto py-4 flex items-center justify-between h-15"
    >
        <h3 class="text-3xl">CaliCloud</h3>
    </div>
    <div
            class="container mx-auto py-4 flex items-center justify-between h-15"
    >
        <div class="text-sm">
            <span>&copy; [2024] [CaliCloud]. All Rights Reserved.</span>
            <span class="mx-2">|</span>
            <a href="#" class="hover:underline">Privacy</a>
            <span class="mx-2">|</span>
            <a href="#" class="hover:underline">Terms &amp; Conditions</a>
        </div>
    </div>
</footer>
</body>
</html>

<script>
    const option_show = document.getElementById("option_show")

    fetch("/backend/api/options.php", {
        method: "GET",
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then((response) => {
            // console.log('Response:', response); // Log the whole response object
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json(); // Proceed to parse JSON if response is okay
        })
        .then(data => {

            console.log("data" + data)
            option_show.innerHTML = ""
            data.forEach(item => {
                let option = document.createElement('li')
                let input = document.createElement('input')

                input.classList.add("mr-2", "option-checkbox")
                input.type = "checkbox"
                input.id = item['id']
                input.name = "option"
                input.value = item['id']
                input.price = item['price']

                option.append(input)
                option.append(document.createTextNode(`${item['name']} +${item['price']}`))
                option_show.append(option)

                input.addEventListener("change", () => {
                    if (input.checked) {
                        totalprice = Number(document.getElementById("total-price").innerHTML) + input.price;
                        console.log(input.price)
                    } else {
                        totalprice = Number(document.getElementById("total-price").innerHTML) - input.price;
                    }
                    document.getElementById("total-price").innerHTML = totalprice;
                    document.getElementById("totalPriceInput").value = totalprice;// อัปเดตฟิลด์ซ่อน
                })
            })
        })

    const urlParams = new URLSearchParams(window.location.search);
    const vehicleID = urlParams.get('vehicleID');

    const vehicleImage = document.getElementById("vehicle_image")
    const vehicleName = document.getElementById("vehicle_name")


    console.log("vehicleID: " + vehicleID)

    //const vehicle_show = document.getElementById("vehicle_show")
    console.log(window.location.search)

    fetch(`/backend/api/vehicles.php?vehicleID=${vehicleID}`, {
        method: "GET",
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then((response) => {
            // console.log('Response:', response); // Log the whole response object
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json(); // Proceed to parse JSON if response is okay
        })
        .then(data => {
            vehicleImage.src = '/' + data['image_url']
            vehicleName.innerHTML = data['name']
            console.log("data['image_url']" + data['image_url'])
            //vehicle_show.innerHTML = ""
            //data.forEach(item => {
            // vehicle_show.innerHTML +=

            //)
        })

</script>

<script>
    function show_payment(open, close) {
        console.log("open = " + open, "close = ", close);
        console.log(document.getElementById(open + "-pay"));
        document.getElementById(open + "-pay").style.display = "block";
        document.getElementById(close + "-pay").style.display = "none";
    }

    function submitForm(event) {
        event.preventDefault(); // ป้องกันการส่งฟอร์มตามปกติ

        // ดึงข้อมูลจากฟอร์ม
        const form = document.getElementById("reservationForm");
        const formData = new FormData(form);
        const data = {};

        formData.forEach((value, key) => {
            data[key] = value;
        });

        console.log(data)

        // ส่งข้อมูลไปยัง backend
        // fetch("/backend/save_reservation.php", {
        //   method: "POST",
        //   headers: {
        //     "Content-Type": "application/json",
        //   },
        //   body: JSON.stringify(data),
        // })
        //   .then((response) => {
        //     if (!response.ok) throw new Error("Network response was not ok");
        //     return response.json();
        //   })
        //   .then((data) => {
        //     console.log("Success:", data);
        //     // ทำอะไรกับผลลัพธ์ที่ได้ เช่น แสดงข้อความหรือเปลี่ยนหน้า
        //   })
        //   .catch((error) => {
        //     console.error("Error:", error);
        //   });
    }
</script>
